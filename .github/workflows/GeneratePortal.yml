name: Portal Generator

on:
  push:
    branches:
      - main
      - dev

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get list of changed directories
        id: changed-dirs
        run: |
          CHANGED_DIRS=$(find . -type d -name 'BuildFiles' | xargs -n1 dirname | sort -u | tr '\n' ' ')
          echo "CHANGED_DIRS=$CHANGED_DIRS" >> $GITHUB_ENV

      # This step helps ensure that environment variables and secrets are set up correctly
      - name: Verify Environment Setup
        run: |
          echo "Changed directories: $CHANGED_DIRS"  # Only minimal output
          echo "API_KEY: (hidden)"  # Don't print the actual secret, just verify it's referenced

      - name: Process and Deploy Changed Directories
        if: env.CHANGED_DIRS
        run: |
          for dir in $CHANGED_DIRS; do
            echo "Processing $dir..."

            # Navigate to the directory
            cd "$dir"

            # Zip the BuildFiles directory (suppress output from zip)
            zip -r portal-input.zip BuildFiles/* > /dev/null

            RESPONSE=$(curl -s --output response.zip --write-out '%{http_code}\t%{content_type}' --request POST \
                        --url 'https://api.apimatic.io/portal' \
                        -H 'Authorization: X-Auth-Key ${{ secrets.APIMATIC_API_KEY }}' \
                        -F "file=@portal-input.zip")

            # Debug: output the raw response and the response file
            echo "Raw curl response: $RESPONSE"
            echo "Response file (response.zip) status:"
            ls -l response.zip

            # Extract the HTTP code and content type
            echo "Extracting HTTP code and content type..."
            HTTP_CODE=$(echo "$RESPONSE" | cut -f1)  # Ensure the HTTP code is correctly captured
            CONTENT_TYPE=$(echo "$RESPONSE" | cut -f2)

            # Debug: output extracted variables
            echo "Extracted HTTP_CODE=$HTTP_CODE"
            echo "Extracted CONTENT_TYPE=$CONTENT_TYPE"

            # Check if the HTTP_CODE is a valid integer
            if ! [[ "$HTTP_CODE" =~ ^[0-9]{3}$ ]]; then
              echo "Invalid HTTP_CODE value: $HTTP_CODE. Expected a 3-digit status code."
              exit 1
            fi

            # Debug: Print the HTTP response code and validate further
            echo "Valid HTTP response code: $HTTP_CODE"

            # Process response based on HTTP code
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "Request successful (HTTP 200). Unzipping response..."
              # Debug: check response.zip size
              echo "Size of response.zip:"
              stat --format="%s bytes" response.zip

              # Unzip the response
              unzip -qq response.zip -d Portal

              # Debug: List unzipped contents
              echo "Unzipped contents:"
              ls -l Portal
            elif [ "$HTTP_CODE" -eq 422 ]; then
              echo "Unprocessable entry. Error encountered."
              exit 1
            elif [ "$HTTP_CODE" -eq 402 ]; then
              echo "Subscription issue. Exiting."
              exit 1
            elif [ "$HTTP_CODE" -eq 401 ]; then
              echo "Authorization issue. Exiting."
              exit 1
            elif [ "$HTTP_CODE" -eq 400 ]; then
              echo "Bad Request. Exiting."
              exit 1
            else
              echo "Unexpected response. HTTP_CODE=$HTTP_CODE, CONTENT_TYPE=$CONTENT_TYPE"
              exit 1
            fi

      - name: Cleanup
        run: |
          rm -f test.zip response.zip
          echo "Cleanup complete"

