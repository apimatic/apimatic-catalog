name: Portal Generator

on:
  push:
    branches:
      - main
      - dev

jobs:
  collect_dirs:
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.collect-dirs.outputs.dirs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Collect Changed Directories
        id: collect-dirs
        run: |
          CHANGED_DIRS=$(find . -type d -name 'BuildFiles' | xargs -n1 dirname | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "directories=$CHANGED_DIRS" >> $GITHUB_ENV
          echo "::set-output name=dirs::$CHANGED_DIRS"
          
  build_and_deploy:
    needs: collect_dirs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: ${{ fromJson(needs.collect_dirs.outputs.dirs) }}
    steps:
      - name: Debug Changed Directories
        run: |
          echo "CHANGED_DIRS: ${{ needs.collect_dirs.outputs.dirs }}"

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Zip BuildFiles and send to APIMatic
        run: |
          cd ${{ matrix.directory }}
          echo "Zipping BuildFiles in ${{ matrix.directory }}..."
          zip -r portal-input.zip BuildFiles/* > /dev/null
          echo "Zipped BuildFiles successfully."

          echo "Sending zip to APIMatic..."
          RESPONSE=$(curl -s --output response.zip --write-out '%{http_code}\t%{content_type}' --request POST \
                      --url 'https://api.apimatic.io/portal' \
                      -H 'Authorization: X-Auth-Key ${{ secrets.APIMATIC_API_KEY }}' \
                      -F "file=@portal-input.zip")
          
          echo "Raw curl response: $RESPONSE"
          HTTP_CODE=$(echo "$RESPONSE" | cut -f1)
          CONTENT_TYPE=$(echo "$RESPONSE" | cut -f2)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "APIMatic transformer failed with HTTP_CODE=$HTTP_CODE. Exiting."
            exit 1
          fi

          echo "Request successful. Unzipping response..."
          mkdir -p Portal
          unzip -qq response.zip -d Portal

      - name: Check and Create Cloudflare Project if Needed
        run: |
          PROJECT_NAME=$(basename ${{ matrix.directory }})-apimatic
          echo "Checking if Cloudflare project '$PROJECT_NAME' exists..."

          # Fetch all existing Cloudflare projects
          EXISTING_PROJECTS=$(curl -s --request GET \
            --url https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects \
            --header 'Content-Type: application/json' \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq -r '.result[].name')

          # Check if the current project name exists in the list
          if echo "$EXISTING_PROJECTS" | grep -q "^$PROJECT_NAME$"; then
            echo "Project '$PROJECT_NAME' already exists on Cloudflare."
          else
            echo "Project '$PROJECT_NAME' not found. Creating new Cloudflare project..."

            # Create the new project
            CREATE_RESPONSE=$(curl -s --request POST \
              --url https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects \
              --header 'Content-Type: application/json' \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              --data '{
                "name": "'"$PROJECT_NAME"'",
                "production_branch": "main"
              }')

            # Check if the project creation was successful
            if echo "$CREATE_RESPONSE" | jq -e '.success' > /dev/null; then
              echo "Successfully created Cloudflare project '$PROJECT_NAME'."
            else
              echo "Failed to create Cloudflare project '$PROJECT_NAME'. Response: $CREATE_RESPONSE"
              exit 1
            fi
          fi

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ${{ matrix.directory }}/Portal --project-name=${{ matrix.directory }}-apimatic-testrun

      - name: Update README.md
        run: |
          echo "${{ matrix.directory }}-apimatic" > ${{ matrix.directory }}/README.md
          curl --request GET \
            --url https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects \
            --header 'Content-Type: application/json' \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq '.result.[].subdomain' | tr -d '"' | sed 's/^/<http:\/\//' | sed 's/$/>/' >> ${{ matrix.directory }}/README.md

      - name: Cleanup
        run: |
          rm -f portal-input.zip response.zip
          echo "Cleanup complete"